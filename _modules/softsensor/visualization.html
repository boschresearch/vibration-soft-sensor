

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>softsensor.visualization &mdash; Template-Python</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=f65bdc5e" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/fix-rtd-property.css?v=3d3ddd9d" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=34f4cfc2"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/thebelab-helper.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            softsensor
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">vibration-soft-sensor   <!-- omit in toc --></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Data Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html#linear-methods">Linear Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html#neural-networks">Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html#training-methods">Training Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html#postprocessing">Postprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html#frequency-methods">Frequency Methods</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">softsensor</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">softsensor.visualization</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for softsensor.visualization</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpl_toolkits.axes_grid1</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats.qmc</span><span class="w"> </span><span class="kn">import</span> <span class="n">LatinHypercube</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">softsensor.autoreg_models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">_postprocess_sens</span><span class="p">,</span> <span class="n">_reshape_array</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">softsensor.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">picp</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="c1"># &quot;font.family&quot;: &quot;CMU Serif&quot;,</span>
    <span class="s2">&quot;axes.xmargin&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="p">})</span>

<span class="c1"># change this to the desired base path of the project</span>
<span class="n">BASE_PATH</span> <span class="o">=</span> <span class="s1">&#39;c:/Users/FSL5FE/MA/Coding/SoftSensorACC/use_cases/Fischer_MA&#39;</span>


<div class="viewcode-block" id="plot_uncertainty">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_uncertainty">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_uncertainty</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the prediction with distributional uncertainty</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : torch.Tensor</span>
<span class="sd">        Point prediction</span>
<span class="sd">    std : torch.Tensor</span>
<span class="sd">        Uncertainty estimate</span>
<span class="sd">    t_start: int, optional</span>
<span class="sd">        Start of plotting window</span>
<span class="sd">    t_end: int, optional</span>
<span class="sd">        End of plotting window</span>
<span class="sd">    ground_truth : torch.Tensor, optional</span>
<span class="sd">        Ground truth of point prediction</span>
<span class="sd">    fs : int, optional</span>
<span class="sd">        Sampling rate. The default is 10</span>
<span class="sd">    n_std : int, optional</span>
<span class="sd">        Amount of standard deviations to plot. The default is 2</span>
<span class="sd">    show_legend : bool, optional   </span>
<span class="sd">        Show legend in the plot. The default is False</span>
<span class="sd">    title: string, optional</span>
<span class="sd">        Title for the plot. The default is None</span>
<span class="sd">    title_info: dict[string,string], optional</span>
<span class="sd">        Must contain keys [&#39;dataset&#39;, &#39;model&#39;, &#39;track&#39;, &#39;sensor&#39;]. The default is None.</span>
<span class="sd">    fig_path : string, optional   </span>
<span class="sd">        Path to save fig. The default is None</span>
<span class="sd">    is_duffing: bool, optional</span>
<span class="sd">        Whether it is position prediction (like Duffing dataset) or acceleration prediction. The default is True.</span>
<span class="sd">    show: bool, optional</span>
<span class="sd">        If the plot should be displayed. The default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">t_start</span><span class="p">:</span><span class="n">t_end</span><span class="p">]</span>
    <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">mean</span><span class="p">]])</span>
    <span class="n">var_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">]])</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_val</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="n">ground_truth</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mean_val</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mean</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">+</span><span class="mf">0.4</span><span class="o">*</span><span class="p">(</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">mean_val</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="p">(</span><span class="n">mean_val</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;Uncertainty </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">$\sigma$&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="plot_uncertainty_both">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_uncertainty_both">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_uncertainty_both</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">epistemic_var</span><span class="p">,</span> <span class="n">aleatoric_var</span><span class="p">,</span> <span class="n">ground_truth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">n_std</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the prediction with aleatoric and epistemic uncertainty</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mean : torch.Tensor</span>
<span class="sd">        Point prediction</span>
<span class="sd">    epistemic_std : torch.Tensor</span>
<span class="sd">        Epistemic uncertainty estimate (e.g. ensemble, mcdo)</span>
<span class="sd">    aleatoric_std : torch.Tensor</span>
<span class="sd">        Aleatoric uncertainty estimate (e.g. mve)</span>
<span class="sd">    t_start: int, optional</span>
<span class="sd">        Start of plotting window</span>
<span class="sd">    t_end: int, optional</span>
<span class="sd">        End of plotting window</span>
<span class="sd">    ground_truth : torch.Tensor, optional</span>
<span class="sd">        Ground truth of point prediction</span>
<span class="sd">    fs : int, optional</span>
<span class="sd">        Sampling rate. The default is 10</span>
<span class="sd">    n_std : int, optional</span>
<span class="sd">        Amount of standard deviations to plot. The default is 2</span>
<span class="sd">    show_legend : bool, optional   </span>
<span class="sd">        Show legend in the plot. The default is False</span>
<span class="sd">    title: string, optional</span>
<span class="sd">        Title for the plot. The default is None</span>
<span class="sd">    title_info: dict[string,string], optional</span>
<span class="sd">        Must contain keys [&#39;dataset&#39;, &#39;model&#39;, &#39;track&#39;, &#39;sensor&#39;]. The default is None.</span>
<span class="sd">    fig_path : string, optional   </span>
<span class="sd">        Path to save fig</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">t_start</span><span class="p">:</span><span class="n">t_end</span><span class="p">]</span>
    <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">mean</span><span class="p">]])</span>
    <span class="n">ep_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">epistemic_var</span><span class="p">]])</span>
    <span class="n">al_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="n">aleatoric_var</span><span class="p">]])</span>
    
    <span class="n">ep_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ep_var</span><span class="p">)</span>
    <span class="n">al_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">al_var</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ground_truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="p">[[</span><span class="n">ground_truth</span><span class="p">]],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ground_truth</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mean_val</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mean</span><span class="p">)</span>
    
    <span class="n">std</span> <span class="o">=</span> <span class="n">ep_std</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">+</span><span class="mf">0.4</span><span class="o">*</span><span class="p">(</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">mean_val</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="p">(</span><span class="n">mean_val</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;Epistemic </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">$\sigma$&quot;</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">ep_std</span> <span class="o">+</span> <span class="n">al_std</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">+</span><span class="mf">0.4</span><span class="o">*</span><span class="p">(</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n_std</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">mean_val</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="p">(</span><span class="n">mean_val</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="sa">rf</span><span class="s2">&quot;Total </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">$\sigma$&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<div class="viewcode-block" id="plot_calibration_curve">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_calibration_curve">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_calibration_curve</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">,</span> <span class="n">model_names</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Runs the model prediction on track and plots the calibration at different quantile levels</span>
<span class="sd">        Assumes that Quantile Regression models have QR in their name and that all other models predict mean and variance</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    models: list[uncertainty models]</span>
<span class="sd">        Models to use for prediction</span>
<span class="sd">    track: torch.Dataloader</span>
<span class="sd">        Single track</span>
<span class="sd">    track_number: int</span>
<span class="sd">        Number of track in the test set</span>
<span class="sd">    out_sens: list[string]</span>
<span class="sd">        Names of output sensors</span>
<span class="sd">    output: int, optional</span>
<span class="sd">        Output sensor to plot. The default is 0.</span>
<span class="sd">    quantiles: list[x], x in (0,1)</span>
<span class="sd">        Quantile levels to analyze for calibration curve. The default is np.arange(0.0, 1.05, 0.05)</span>
<span class="sd">    fig_path : string, optional   </span>
<span class="sd">        Path to save fig. The default is None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">quantiles</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">model_names</span><span class="p">:</span>
        <span class="n">mean_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ground_truth</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]]))</span>
        <span class="n">var_val</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ground_truth</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_var&#39;</span><span class="p">]]))</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[[</span><span class="n">ground_truth</span><span class="p">]]))</span>

        <span class="n">z_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">quantiles</span><span class="p">]</span>
        <span class="n">picp_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">picp</span><span class="p">(</span><span class="n">mean_val</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">var_val</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_scores</span><span class="p">])</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">quantiles</span><span class="p">,</span> <span class="n">picp_scores</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Expected Confidence Level&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Observed Confidence Level&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">show_legend</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert the channel names to LaTeX scientific notation if applicable.&quot;&quot;&quot;</span>
    <span class="n">ch_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Duffing_MVE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$F(t)$&#39;</span><span class="p">,</span> <span class="s1">&#39;$x$&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Duffing_Enhanced&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$F(t)$&#39;</span><span class="p">,</span> <span class="s1">&#39;$x_{</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$x$&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Duffing_Delta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$F(t)$&#39;</span><span class="p">,</span> <span class="s1">&#39;$x_{</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Delta x$&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Duffing_Comparison&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$F(t)$&#39;</span><span class="p">,</span> <span class="s1">&#39;$x_{</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$(</span><span class="se">\\</span><span class="s1">Delta) x$&#39;</span><span class="p">],</span>

        <span class="s1">&#39;Steering_MVE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$M2_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_z$&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Steering_Enhanced&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$M2_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_{x,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;$M8_{y,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_{z,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_z$&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Steering_Delta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$M2_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_{x,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;$M8_{y,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_{z,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Delta M8_</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Delta M8_</span><span class="si">{y}</span><span class="s1">$&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">Delta M8_</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Steering_Comparison&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;$M2_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M2_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_x$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_y$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M3_z$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_{x,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;$M8_{y,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$M8_{z,</span><span class="se">\\</span><span class="s1">text</span><span class="si">{lin}</span><span class="s1">}$&#39;</span><span class="p">,</span> <span class="s1">&#39;$(</span><span class="se">\\</span><span class="s1">Delta) M8_</span><span class="si">{x}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="s1">&#39;$(</span><span class="se">\\</span><span class="s1">Delta) M8_</span><span class="si">{y}</span><span class="s1">$&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;$(</span><span class="se">\\</span><span class="s1">Delta) M8_</span><span class="si">{z}</span><span class="s1">$&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">ch_names</span><span class="p">:</span>
        <span class="n">ch_str</span> <span class="o">=</span> <span class="n">ch_dict</span><span class="p">[</span><span class="n">use_case</span><span class="p">]</span> <span class="k">if</span> <span class="n">use_case</span> <span class="ow">in</span> <span class="n">ch_dict</span> <span class="k">else</span> <span class="n">ch_str</span>
    <span class="k">return</span> <span class="n">ch_str</span>


<div class="viewcode-block" id="plot_sens_analysis">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_sens_analysis">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_sens_analysis</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">ch_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">orig_length</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize different metrics/insights of the post-processed arrays,</span>
<span class="sd">    coming from differently averaged sensitivities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Model consisting of nn.Modules</span>
<span class="sd">    sensitivity : torch.Tensor</span>
<span class="sd">        Sensitivity tensor that contains the gradients of the output with respect to the inputs</span>
<span class="sd">    ch_names : list of strings, optional</span>
<span class="sd">        List of channel names. The default is None, i.e. the channel names are not provided and</span>
<span class="sd">        will be generated in the style of &#39;Inp_ch_i&#39; and &#39;Rec_ch_i&#39;.</span>
<span class="sd">    title : string, optional</span>
<span class="sd">        Title for the plot series. The default is None, i.e. no title is displayed.</span>
<span class="sd">    annotations : bool, optional</span>
<span class="sd">        If the plot should contain the percentages of the channel-wise mean sensitivities.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    orig_length : int, optional</span>
<span class="sd">        Original length of the time series. Only needed when sensitivity analysis is performed on</span>
<span class="sd">        subset of the data. The default is None, i.e. the original length is not provided.</span>
<span class="sd">    save_path : string, optional</span>
<span class="sd">        Path to save the plots. The default is None, i.e. the plots are not saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Postprocess the sensitivity tensor</span>
    <span class="n">sum_mean_std_feature</span><span class="p">,</span> <span class="n">sum_mean_std_inp_channels</span><span class="p">,</span> <span class="n">out_ch_sens</span> <span class="o">=</span> <span class="n">_postprocess_sens</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">)</span>
    <span class="n">rms_out_ch_sens</span> <span class="o">=</span> <span class="n">out_ch_sens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;### Sensitivity analysis results for </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> model ###&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">)</span>
        <span class="n">use_case_str</span> <span class="o">=</span> <span class="n">use_case</span> <span class="k">if</span> <span class="n">use_case</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;Evaluation_plots&#39;</span><span class="p">,</span> <span class="n">use_case_str</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">m_type</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Type</span>
    <span class="n">input_channels</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span>
    <span class="n">pred_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pred_size</span>
    <span class="n">num_timesteps</span><span class="p">,</span> <span class="n">num_features</span> <span class="o">=</span> <span class="n">rms_out_ch_sens</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
        <span class="n">win_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">)</span>
        <span class="n">ch_size</span> <span class="o">=</span> <span class="n">input_channels</span> <span class="o">+</span> <span class="n">pred_size</span>
        <span class="n">rec_start_idx</span> <span class="o">=</span> <span class="n">input_channels</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span>
        <span class="n">flatten_size</span> <span class="o">=</span> <span class="n">rec_start_idx</span> <span class="o">+</span> <span class="n">pred_size</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span>
        <span class="n">ch_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Inp_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_channels</span><span class="p">)]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Rec_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span>
        <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">)]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">)]</span>
        <span class="n">x_center</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">)]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="o">+</span><span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">win_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span>
        <span class="n">ch_size</span> <span class="o">=</span> <span class="n">input_channels</span>
        <span class="n">rec_start_idx</span> <span class="o">=</span> <span class="n">input_channels</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span>
        <span class="n">flatten_size</span> <span class="o">=</span> <span class="n">rec_start_idx</span>
        <span class="n">ch_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Inp_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_channels</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span>
        <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">)]</span>
    
    <span class="c1"># LaTeX scientific notation for channel names</span>
    <span class="n">new_ticks_pos</span> <span class="o">=</span> <span class="n">x_tks_feat</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_tks_feat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_tks_feat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">ch_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Out_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span><span class="p">[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">out_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="mi">65</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">halign</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span> <span class="c1"># if ch_size &lt; 5 else &#39;center&#39;</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">8</span>
    <span class="n">ax_zero_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;RMS of Mean Sensitivities  $[-]$&#39;</span>
    <span class="n">ax_one_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;RMS of Std. Dev. of Sensitivities  $[-]$&#39;</span>
    
    <span class="c1"># Plot the sum_mean_inp_channels, sum_std_inp_channels as heatmaps</span>
    <span class="n">sum_inp_channels</span><span class="p">,</span> <span class="n">std_inp_channels</span> <span class="o">=</span> <span class="n">sum_mean_std_inp_channels</span> <span class="c1"># unpack tuple</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pred_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="n">ch_str</span>
        <span class="n">mean_values</span><span class="p">,</span> <span class="n">std_values</span> <span class="o">=</span> <span class="n">sum_inp_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">std_inp_channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mean_norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">mean_values</span><span class="p">))</span>
        <span class="n">std_norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">std_values</span><span class="p">))</span>
        <span class="n">color_scheme</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Reds&#39;</span><span class="p">)</span>
        <span class="n">mean_colors</span> <span class="o">=</span> <span class="n">color_scheme</span><span class="p">(</span><span class="n">mean_norm</span><span class="p">(</span><span class="n">mean_values</span><span class="p">))</span>
        <span class="n">std_colors</span> <span class="o">=</span> <span class="n">color_scheme</span><span class="p">(</span><span class="n">std_norm</span><span class="p">(</span><span class="n">std_values</span><span class="p">))</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">mean_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">mean_colors</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.75</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">std_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">std_colors</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.75</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_zero_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_one_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pos0</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sum_inp_channels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                            <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ch_size</span><span class="p">,</span> <span class="n">pred_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cbar0</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cbar0</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">set_powerlimits</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">cbar0</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">set_useMathText</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pos1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">std_inp_channels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Reds&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                            <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ch_size</span><span class="p">,</span> <span class="n">pred_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cbar1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cbar1</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">set_powerlimits</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">cbar1</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">set_useMathText</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Input Channels&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ch_size</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ch_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pred_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Output Channels&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ch_str</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pred_size</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">out_str</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;sens_imshow.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Summed Sensitivities across Input &amp; Output Channels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Mean Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Std. Dev. of Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># Plot the sum_mean_feature, sum_std_feature as bar plots</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.xmargin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
    <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">sum_std_feature</span> <span class="o">=</span> <span class="n">sum_mean_std_feature</span> <span class="c1"># unpack tuple</span>
    <span class="n">ch_mean</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ch_std_mean</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_std_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="n">ch_median</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ch_std_median</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_std_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;None&#39;</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sum_std_feature</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
    <span class="c1"># add a step plot for the mean value of each input/recurrent channel</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ch_mean</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ch_std_mean</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ch_median</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ch_std_median</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

    <span class="c1"># create manual legend</span>
    <span class="n">legend_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">Patch</span><span class="p">(</span><span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Local&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Sensitivity $s_</span><span class="si">{ik}</span><span class="s1">$&#39;</span><span class="p">),</span>
                      <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Channel&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Mean $\mu_k$&#39;</span><span class="p">),</span>
                      <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Channel&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;Median $P_{50, k}$&#39;</span><span class="p">)]</span>

    <span class="c1"># plot annotations for the channel-wise percentages if flag is set</span>
    <span class="k">if</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">perc_mean</span> <span class="o">=</span> <span class="n">means</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
        <span class="n">x_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_tks_feat</span><span class="p">]</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">x_center</span>
        <span class="n">y_positions</span> <span class="o">=</span> <span class="n">means</span><span class="o">*</span><span class="mf">1.25</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">means</span><span class="o">*</span><span class="mf">2.5</span>
        <span class="k">for</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">perc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_positions</span><span class="p">,</span> <span class="n">y_positions</span><span class="p">,</span> <span class="n">perc_mean</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">perc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_zero_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_one_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_entries</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Input Channels&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tks_feat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_ticks_pos</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.06</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ch_str</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;sens_barplot.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sensitivities across all Channels, RMS over Output Channels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Mean Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Std. Dev. of Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.xmargin&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">})</span>


    <span class="c1"># Plot the averages across the time windows for each channel as line plots</span>
    <span class="n">rms_sum_out</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">)</span>
    <span class="n">std_sum_out</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_std_feature</span><span class="p">)</span>

    <span class="n">rms_sum_inp</span><span class="p">,</span> <span class="n">rms_sum_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rms_sum_out</span><span class="p">,</span> <span class="p">[</span><span class="n">input_channels</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">std_sum_inp</span><span class="p">,</span> <span class="n">std_sum_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">std_sum_out</span><span class="p">,</span> <span class="p">[</span><span class="n">input_channels</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_case</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Enhanced&#39;</span> <span class="ow">in</span> <span class="n">use_case</span> <span class="ow">or</span> <span class="s1">&#39;Delta&#39;</span> <span class="ow">in</span> <span class="n">use_case</span><span class="p">):</span> <span class="c1"># in case a linear pre-computed solution exists</span>
        <span class="n">rms_sum_inp</span><span class="p">,</span> <span class="n">rms_sum_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rms_sum_inp</span><span class="p">,</span> <span class="p">[</span><span class="n">input_channels</span><span class="o">-</span><span class="n">pred_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std_sum_inp</span><span class="p">,</span> <span class="n">std_sum_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">std_sum_inp</span><span class="p">,</span> <span class="p">[</span><span class="n">input_channels</span><span class="o">-</span><span class="n">pred_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_rms_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_sum_lin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_std_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std_sum_lin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std_dev_rms_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rms_sum_lin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std_dev_std_lin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">std_sum_lin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">mean_rms_inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_sum_inp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mean_std_inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std_sum_inp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">std_dev_rms_inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rms_sum_inp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">std_dev_std_inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">std_sum_inp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
        <span class="n">mean_rms_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_sum_rec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_std_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std_sum_rec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std_dev_rms_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rms_sum_rec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std_dev_std_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">std_sum_rec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">alpha_val</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="p">(</span><span class="n">input_channels</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">pred_size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">lw</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="k">if</span> <span class="p">(</span><span class="n">input_channels</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">pred_size</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.8</span>
    <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">input_channels</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rms_sum_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_sum_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rms_sum_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_sum_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_rms_inp</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mu_\text</span><span class="si">{inp}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_std_inp</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mu_\text</span><span class="si">{inp}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean_rms_inp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean_rms_inp</span><span class="o">-</span><span class="n">std_dev_rms_inp</span><span class="p">,</span>
                            <span class="n">mean_rms_inp</span><span class="o">+</span><span class="n">std_dev_rms_inp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_\text</span><span class="si">{inp}</span><span class="s1">$&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean_std_inp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean_std_inp</span><span class="o">-</span><span class="n">std_dev_std_inp</span><span class="p">,</span>
                            <span class="n">mean_std_inp</span><span class="o">+</span><span class="n">std_dev_std_inp</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_\text</span><span class="si">{inp}</span><span class="s1">$&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">use_case</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Enhanced&#39;</span> <span class="ow">in</span> <span class="n">use_case</span> <span class="ow">or</span> <span class="s1">&#39;Delta&#39;</span> <span class="ow">in</span> <span class="n">use_case</span><span class="p">):</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_rms_lin</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mu_\text</span><span class="si">{lin}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_std_lin</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mu_\text</span><span class="si">{lin}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean_rms_lin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean_rms_lin</span><span class="o">-</span><span class="n">std_dev_rms_lin</span><span class="p">,</span>
                                <span class="n">mean_rms_lin</span><span class="o">+</span><span class="n">std_dev_rms_lin</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palegreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_\text</span><span class="si">{lin}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean_std_lin</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean_std_lin</span><span class="o">-</span><span class="n">std_dev_std_lin</span><span class="p">,</span>
                                <span class="n">mean_std_lin</span><span class="o">+</span><span class="n">std_dev_std_lin</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;palegreen&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_\text</span><span class="si">{lin}</span><span class="s1">$&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_rms_rec</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mu_\text</span><span class="si">{rec}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean_std_rec</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\mu_\text</span><span class="si">{rec}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean_rms_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean_rms_rec</span><span class="o">-</span><span class="n">std_dev_rms_rec</span><span class="p">,</span>
                                <span class="n">mean_rms_rec</span><span class="o">+</span><span class="n">std_dev_rms_rec</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_\text</span><span class="si">{rec}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean_std_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean_std_rec</span><span class="o">-</span><span class="n">std_dev_std_rec</span><span class="p">,</span>
                                <span class="n">mean_std_rec</span><span class="o">+</span><span class="n">std_dev_std_rec</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\sigma_\text</span><span class="si">{rec}</span><span class="s1">$&#39;</span><span class="p">)</span>
    
    <span class="n">time_deltas</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">10</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="mi">20</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">25</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">30</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">40</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mi">50</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mi">75</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="mi">100</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="mi">125</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="mi">150</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="mi">175</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span>
        <span class="mi">200</span><span class="p">:</span> <span class="mi">40</span>
    <span class="p">}</span>
    <span class="n">time_delta</span> <span class="o">=</span> <span class="n">time_deltas</span><span class="p">[</span><span class="n">win_size</span><span class="p">]</span>
    <span class="n">time_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;t-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">win_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">time_delta</span><span class="p">)][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">time_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_zero_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_one_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Sliding Time Window  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">win_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">time_delta</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_case</span> <span class="ow">and</span> <span class="p">(</span><span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_Enhanced&#39;</span> <span class="ow">or</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_Delta&#39;</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">use_case</span> <span class="ow">and</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_MVE&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">new_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">handles</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">handles</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">new_handles</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;sens_sliding_time_window.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sensitivities across Time Window for all Channels, RMS over Output Channels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Mean Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Std of Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># Plot the temporal development for one selected channel as line plots</span>
    <span class="n">ch_idx</span> <span class="o">=</span> <span class="n">ch_size</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># to be chosen between 0 and ch_size-1</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="c1"># Define a custom colormap from light blue to light green</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;blue_to_green&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">])</span>
    <span class="c1"># Randomly select 50 time steps (if applicable) and sort them to avoid aliasing effects</span>
    <span class="k">if</span> <span class="n">num_timesteps</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">LatinHypercube</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">random_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">samples</span> <span class="o">*</span> <span class="n">num_timesteps</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">random_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_timesteps</span><span class="p">)</span>
    <span class="n">temp_dev_ch</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">rms_out_ch_sens</span><span class="p">,</span> <span class="n">remove_nans</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">temp_dev_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">ch_idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">temp_dev_ch</span><span class="p">])</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temp_dev_ch</span><span class="p">[</span><span class="n">random_indices</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">temp_dev_ch</span><span class="p">[</span><span class="n">random_indices</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">random_indices</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">num_timesteps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">random_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_dev_ch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Time Values&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_dev_ch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Mean $\mu$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean</span><span class="o">-</span><span class="n">std_dev</span><span class="p">,</span> <span class="n">mean</span><span class="o">+</span><span class="n">std_dev</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Std. Dev. $\pm\sigma$&#39;</span><span class="p">)</span>

    <span class="n">wind_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span> <span class="k">if</span> <span class="n">ch_idx</span> <span class="o">&lt;</span> <span class="n">input_channels</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span>
    <span class="n">time_delta</span> <span class="o">=</span> <span class="n">time_deltas</span><span class="p">[</span><span class="n">wind_size</span><span class="p">]</span>
    <span class="n">time_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;t-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">wind_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">time_delta</span><span class="p">)][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">time_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Sliding Time Window  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_zero_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">wind_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">time_delta</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sens_window_ch_</span><span class="si">{</span><span class="n">ch_idx</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ch_name</span> <span class="o">=</span> <span class="s1">&#39;Input&#39;</span> <span class="k">if</span> <span class="n">ch_idx</span> <span class="o">&lt;</span> <span class="n">input_channels</span> <span class="k">else</span> <span class="s1">&#39;Recurrent&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Temporal Development across Time Window for </span><span class="si">{</span><span class="n">ch_name</span><span class="si">}</span><span class="s1"> Channel &quot;</span><span class="si">{</span><span class="n">ch_str</span><span class="p">[</span><span class="n">ch_idx</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># Plot the temporal development for all channels as line plots</span>
    <span class="c1"># &#39;mean&#39; for correlation with output signal, &#39;rms&#39; for effective-valued aggregation</span>
    <span class="n">temp_seasonal</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">rms_out_ch_sens</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;rms&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">x_length</span> <span class="o">=</span> <span class="n">num_timesteps</span><span class="o">/</span><span class="mi">10</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">orig_length</span> <span class="k">else</span> <span class="n">orig_length</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">filter_size</span> <span class="o">=</span> <span class="n">win_size</span><span class="o">//</span><span class="mi">2</span> <span class="k">if</span> <span class="n">flatten_size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">*</span><span class="n">win_size</span> <span class="k">else</span> <span class="n">win_size</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch_size</span><span class="p">):</span>
        <span class="c1"># compute the running average for each channel</span>
        <span class="k">if</span> <span class="n">flatten_size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">*</span><span class="n">win_size</span><span class="p">:</span>
            <span class="n">temp_season</span> <span class="o">=</span> <span class="n">temp_seasonal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_season</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">temp_seasonal</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">filter_size</span><span class="p">)</span><span class="o">/</span><span class="n">filter_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
            <span class="n">temp_season</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">filter_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">temp_season</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">input_channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_season</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_season</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_season</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Time  $[s]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_zero_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_timesteps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">num_timesteps</span><span class="o">//</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_length</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">x_length</span><span class="o">//</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_case</span> <span class="ow">and</span> <span class="p">(</span><span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_Enhanced&#39;</span> <span class="ow">or</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_Delta&#39;</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_case</span> <span class="ow">and</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_MVE&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;sens_seasonalities.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Global Development of Channel Sensitivities, RMS over Output Channels&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_fft_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="n">magnitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">signal</span><span class="p">))</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">sampling_rate</span><span class="p">)</span>
        <span class="n">dominant_freq</span> <span class="o">=</span> <span class="n">frequencies</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">magnitudes</span><span class="p">[:</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">dominant_freq</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">[:</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">magnitudes</span><span class="p">[:</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span>

    <span class="c1"># Plot the frequency spectra of the sensitivities for each channel (DUFFING oscillator only)</span>
    <span class="k">if</span> <span class="n">use_case</span> <span class="ow">and</span> <span class="s1">&#39;Duffing&#39;</span> <span class="ow">in</span> <span class="n">use_case</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch_size</span><span class="p">):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">mags</span> <span class="o">=</span> <span class="n">_fft_signal</span><span class="p">(</span><span class="n">temp_seasonal</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">mags</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ch_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#: {dominant_freq:.1f} Hz&#39;)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_Enhanced&#39;</span> <span class="ow">or</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_Delta&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_MVE&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Frequency  $[Hz]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Magnitude  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;sens_ffts.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Frequency Spectra of Channel Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># Plot the temporal fluctuations of the sensitivities</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.xmargin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">sum_out_ch_sensi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_timesteps</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span> <span class="n">rms_out_ch_sens</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">step_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">flatten_size</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">random_indices</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">num_timesteps</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">random_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sum_out_ch_sensi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">::</span><span class="n">step_size</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Time Values&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sum_out_ch_sensi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">::</span><span class="n">step_size</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sum_out_ch_sensi</span><span class="p">[</span><span class="n">random_indices</span><span class="p">,</span> <span class="p">::</span><span class="n">step_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sum_out_ch_sensi</span><span class="p">[</span><span class="n">random_indices</span><span class="p">,</span> <span class="p">::</span><span class="n">step_size</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Mean $\mu$&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mean</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mean</span><span class="o">-</span><span class="n">std</span><span class="p">,</span> <span class="n">mean</span><span class="o">+</span><span class="n">std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Std. Dev. $\pm\sigma$&#39;</span><span class="p">)</span>

    <span class="n">temp_dev_rms_out</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">rms_out_ch_sens</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
    <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">temp_dev_rms_out</span><span class="p">[</span><span class="n">random_indices</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">percentages</span> <span class="o">=</span> <span class="n">means</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
    <span class="n">temp1</span> <span class="o">=</span> <span class="n">means</span><span class="p">[:</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">means</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">:]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">)</span>
        <span class="n">mean_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">temp1</span><span class="p">),</span> <span class="n">temp2</span><span class="p">))[::</span><span class="n">step_size</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mean_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">temp1</span><span class="p">)[::</span><span class="n">step_size</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mean_steps</span><span class="p">)),</span> <span class="n">mean_steps</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Channel Mean&#39;</span><span class="p">)</span>

    <span class="c1"># plot annotations for the channel-wise percentages if flag is set</span>
    <span class="k">if</span> <span class="n">annotations</span><span class="p">:</span>
        <span class="n">x_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">step_size</span><span class="o">+</span><span class="mi">5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_tks_feat</span><span class="p">]</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">step_size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_center</span><span class="p">]</span>
        <span class="n">y_positions</span> <span class="o">=</span> <span class="n">means</span><span class="o">*</span><span class="mf">1.25</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="n">means</span><span class="o">*</span><span class="mf">2.5</span>
        <span class="k">for</span> <span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">perc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_positions</span><span class="p">,</span> <span class="n">y_positions</span><span class="p">,</span> <span class="n">percentages</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">perc</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="o">/</span><span class="n">step_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Input Channels&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;RMS of Sensitivities  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">i</span><span class="o">/</span><span class="n">step_size</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_tks_feat</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_ticks_pos</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.06</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ch_str</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;sens_temp_dev.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Temporal Fluctuations of Sensitivities, RMS over Output Channels&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.xmargin&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">})</span></div>



<div class="viewcode-block" id="plot_feature_importance">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_feature_importance">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_feature_importance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">ch_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize the feature importance of the sensitivity tensor for a given model, at a specific time step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">)</span>
        <span class="n">use_case_str</span> <span class="o">=</span> <span class="n">use_case</span> <span class="k">if</span> <span class="n">use_case</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;Evaluation_plots&#39;</span><span class="p">,</span> <span class="n">use_case_str</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Postprocess the sensitivity tensor</span>
    <span class="n">sens_str</span> <span class="o">=</span> <span class="s1">&#39;Mean&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Pred_Type</span> <span class="o">==</span> <span class="s1">&#39;Mean_Var&#39;</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">Ensemble</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Point&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">[</span><span class="n">sens_str</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">[</span><span class="n">sens_str</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="p">[</span><span class="n">sens_str</span><span class="p">]</span>
    <span class="n">mean_out_ch_sens</span> <span class="o">=</span> <span class="n">_postprocess_sens</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">m_type</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Type</span>
    <span class="n">input_channels</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span>
    <span class="n">pred_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pred_size</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="n">mean_out_ch_sens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
        <span class="n">ch_size</span> <span class="o">=</span> <span class="n">input_channels</span> <span class="o">+</span> <span class="n">pred_size</span>
        <span class="n">rec_start_idx</span> <span class="o">=</span> <span class="n">input_channels</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span>
        <span class="n">ch_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Inp_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_channels</span><span class="p">)]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Rec_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span>
        <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">)]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ch_size</span> <span class="o">=</span> <span class="n">input_channels</span>
        <span class="n">ch_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Inp_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_channels</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span>
        <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">)]</span>
    
    <span class="c1"># LaTeX scientific notation for channel names</span>
    <span class="n">ch_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Out_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span><span class="p">[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">out_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="mi">65</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">halign</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span> <span class="c1"># if ch_size &lt; 5 else &#39;center&#39;</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">8</span>

    <span class="c1"># Plot the mean_feature as bar plots for one specific time step</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.xmargin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
    <span class="n">time_steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_step</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time_step</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">time_step</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="c1"># alpha = 0.8 if len(time_steps) == 1 else 0.5</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span> <span class="s1">&#39;#8c564b&#39;</span><span class="p">]</span> <span class="c1"># i.e. blue, green, purple, brown</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">alphas</span><span class="p">)):</span>
        <span class="n">feat_imp</span> <span class="o">=</span> <span class="n">mean_out_ch_sens</span><span class="p">[</span><span class="n">step</span><span class="p">]</span>
        <span class="n">ch_mean</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">feat_imp</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">feat_imp</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">ch_mean</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    
    <span class="c1"># create manual legend</span>
    <span class="n">legend_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">time_steps</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
        <span class="n">legend_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Local Sensitivities&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">rf</span><span class="s1">&#39; $s_</span><span class="se">{{</span><span class="s1">ik</span><span class="se">}}</span><span class="s1">\vert_</span><span class="se">{{</span><span class="s1">t=</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="se">}}</span><span class="s1">$&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_steps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">legend_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Channel Mean&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">rf</span><span class="s1">&#39;Sensitivities $\mu_k\vert_</span><span class="se">{{</span><span class="s1">t=</span><span class="si">{</span><span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">}}</span><span class="s1">$&#39;</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Mean Sensitivities  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_entries</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Input Channels&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tks_feat</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ch_str</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">ticklabel_format</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span> <span class="n">scilimits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">useMathText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;AR&#39;</span><span class="p">,</span> <span class="s1">&#39;AR_RNN&#39;</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sens_barplot_timestep_</span><span class="si">{</span><span class="n">time_step</span><span class="si">}</span><span class="s1">.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sensitivities across all Channels for Time Step </span><span class="si">{</span><span class="n">time_step</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;axes.xmargin&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">})</span></div>



<div class="viewcode-block" id="plot_uncertainty_sens">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_uncertainty_sens">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_uncertainty_sens</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sens_uq</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">ch_names</span><span class="p">,</span> <span class="n">use_case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">amplification</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize the uncertainty of the sensitivity tensor for a given model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Model consisting of nn.Modules</span>
<span class="sd">    sens_uq : torch.Tensor</span>
<span class="sd">        Sensitivity tensor that contains the gradients of the output with respect to the inputs</span>
<span class="sd">    eps : float</span>
<span class="sd">        Epsilon value for the uncertainty quantification</span>
<span class="sd">    ch_names : list of strings</span>
<span class="sd">        List of channel names</span>
<span class="sd">    use_case : string, optional</span>
<span class="sd">        Use case for the channel names. The default is use_case.</span>
<span class="sd">    amplification : int, optional</span>
<span class="sd">        Amplification factor for the uncertainty quantification of sensitivities of MVE models. The default is 1.</span>
<span class="sd">    save_path : string, optional</span>
<span class="sd">        Path to save the plots. The default is None, i.e. the plots are not saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">)</span>
        <span class="n">use_case_str</span> <span class="o">=</span> <span class="n">use_case</span> <span class="k">if</span> <span class="n">use_case</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;Evaluation_plots&#39;</span><span class="p">,</span> <span class="n">use_case_str</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Postprocess the sensitivity tensor</span>
    <span class="n">sens_uq</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">sens_uq</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">eps</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">sum_win_size_sens</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sens_uq</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;rms&#39;</span><span class="p">)</span> <span class="c1"># shape [sens_length*random_samples, pred_size, input_channels+pred_size]</span>

    <span class="n">pred_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pred_size</span>
    <span class="n">ch_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">+</span> <span class="n">pred_size</span>
    <span class="n">ch_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Inp_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">)]</span> <span class="o">+</span> \
        <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Rec_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span>
    <span class="n">ch_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Out_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span><span class="p">[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">out_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">use_case</span> <span class="ow">and</span> <span class="n">use_case</span> <span class="o">==</span> <span class="s1">&#39;Duffing_MVE&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">]</span>
    <span class="c1"># scale the step_size appropriately, such that always 1000 data points are plotted</span>
    <span class="n">step_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">eps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">1000</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shapes:&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="p">[::</span><span class="n">step_size</span><span class="p">,:]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sum_win_size_sens</span><span class="p">[::</span><span class="n">step_size</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Formulate fitting function for parabola</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_uncertainty</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">num_sects</span><span class="p">):</span>
        <span class="n">x_sections</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">num_sects</span><span class="p">)</span>
        <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">x_sections</span><span class="p">:</span>
            <span class="n">sect_idc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">section</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">section</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">sect_idc</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)</span>

    <span class="c1"># Plot the uncertainty of the sensitivity tensor</span>
    <span class="n">x_lim</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">amplification</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pred_size</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">axs</span><span class="p">]</span> <span class="k">if</span> <span class="n">pred_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axs</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
        <span class="n">x_</span> <span class="o">=</span> <span class="n">eps</span><span class="p">[::</span><span class="n">step_size</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_</span><span class="p">[(</span><span class="n">x_</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">x_lim</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_</span> <span class="o">&lt;</span> <span class="n">x_lim</span><span class="p">)]</span> <span class="c1"># remove outliers outside the 3-sigma confidence interval</span>
        <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_histx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_histy</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">amplification</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ch_size</span><span class="p">),</span> <span class="n">colors</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">sum_win_size_sens</span><span class="p">[::</span><span class="n">step_size</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[(</span><span class="n">x_</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">x_lim</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_</span> <span class="o">&lt;</span> <span class="n">x_lim</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ch_str</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax_histy</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
            <span class="c1"># fit a quadratic function to the data, weighted by the square root of the output sensitivity</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">fit_func</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fitted parabola for Channel </span><span class="si">{</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">*x^2 + </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">*x + </span><span class="si">{</span><span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">fit_func</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">stds</span> <span class="o">=</span> <span class="n">compute_uncertainty</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_fit</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">fit_func</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span><span class="o">-</span><span class="n">stds</span><span class="p">,</span> <span class="n">fit_func</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span><span class="o">+</span><span class="n">stds</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        
        <span class="n">ax_histx</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax_histy</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">x_lim</span><span class="p">,</span> <span class="n">x_lim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\frac{x-\mu}{\sigma}$  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Output Sensitivity  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0125</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.29</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;uncertainty_sens.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sensitivity Range Across the Aleatoric Uncertainty in the Predicted Output&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axs</span><span class="p">):</span>
            <span class="n">ax_histx</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Recurrent Channel </span><span class="si">{</span><span class="n">out_str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_grad_sens_comparison">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_grad_sens_comparison">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_grad_sens_comparison</span><span class="p">(</span><span class="n">vals_dict</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">sum_mean_std_list</span><span class="p">,</span> <span class="n">ch_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scientific_notation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize the comparison of the sensitivity tensors of different models</span>
<span class="sd">    for the same prediction type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vals_dict: dict</span>
<span class="sd">        Dict, containing the mode to compare, e.g. alpha, excitation amplitude/frequency;</span>
<span class="sd">        as well as the values to compare, e.g. [0.1, 0.2, 0.3]</span>
<span class="sd">    models : list[Model consisting of nn.Modules]</span>
<span class="sd">        Models consisting of nn.Modules</span>
<span class="sd">    sum_mean_std_list : list of torch.Tensor</span>
<span class="sd">        List of sensitivity tensors that contain the gradients of the output with respect to the inputs</span>
<span class="sd">    ch_names : list of strings, optional</span>
<span class="sd">        List of channel names. The default is None, i.e. the channel names are not provided and</span>
<span class="sd">        will be generated in the style of &#39;Inp_ch_i&#39; and &#39;Rec_ch_i&#39;.</span>
<span class="sd">    scientific_notation : bool, optional</span>
<span class="sd">        If the plot legends should be displayed in LaTeX scientific notation. The default is False.</span>
<span class="sd">    save_path : string, optional</span>
<span class="sd">        Path to save the plots. The default is None, i.e. the plots are not saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">folder</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;Evaluation_plots&#39;</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">win_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">)</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">])</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">same_ch_sizes</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([(</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">input_channels</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">])</span>
    <span class="c1"># find the model with the maximum number of input channels</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">m</span>

    <span class="n">max_inp_chs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span>
    <span class="n">num_chs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">pred_size</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="n">win_size</span> <span class="o">*</span> <span class="n">num_chs</span>
    <span class="n">ch_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Inp_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">)]</span> <span class="o">+</span> \
        <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Rec_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span>
    <span class="n">ch_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)</span>
    <span class="n">ax_zero_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;RMS of Sensitivities  $[-]$&#39;</span>
    <span class="n">ax_one_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;RMS of Std. Dev. of Sensitivities  $[-]$&#39;</span>

    <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">win_size</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">scientific_notation</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">]</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;//&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;//&#39;</span><span class="p">]</span>

    <span class="c1"># Plot the sum_mean_feature, sum_std_feature as bar plots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">bar_width</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mf">0.25</span>
    <span class="n">bar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_chs</span><span class="p">)</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">bar_width</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bar1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">bars</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bar1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">br</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">sum_mean_std_list</span><span class="p">,</span> <span class="n">bars</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">alphas</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">vals_dict</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]):</span>
        <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">sum_std_feature</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># unpack tuple</span>

        <span class="k">if</span> <span class="n">num_chs</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">rms_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
            <span class="n">std_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_std_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">same_ch_sizes</span> <span class="ow">and</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">&lt;</span> <span class="n">max_inp_chs</span><span class="p">):</span>
                <span class="n">insert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">rms_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rms_sum_out_inp_ch</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">insert</span><span class="p">)</span>
                <span class="n">std_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std_sum_out_inp_ch</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">insert</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">br</span><span class="p">,</span> <span class="n">rms_sum_out_inp_ch</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="n">pat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">br</span><span class="p">,</span> <span class="n">std_sum_out_inp_ch</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">hatch</span><span class="o">=</span><span class="n">pat</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">rms_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                                               <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">)</span>
            <span class="n">std_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_std_feature</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                                               <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">repeat_size</span><span class="o">=</span><span class="n">win_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">same_ch_sizes</span> <span class="ow">and</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">&lt;</span> <span class="n">max_inp_chs</span><span class="p">):</span>
                <span class="n">rec_start_idx</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="o">*</span><span class="n">win_size</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">insert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">win_size</span><span class="p">)</span>
                <span class="n">rms_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rms_sum_out_inp_ch</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">insert</span><span class="p">)</span>
                <span class="n">std_sum_out_inp_ch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std_sum_out_inp_ch</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">insert</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">rms_sum_out_inp_ch</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_features</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">std_sum_out_inp_ch</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">angle</span> <span class="o">=</span> <span class="mi">65</span> <span class="k">if</span> <span class="n">num_chs</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">halign</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span> <span class="k">if</span> <span class="n">num_chs</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="s1">&#39;left&#39;</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_zero_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_one_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_chs</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">bar_width</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bar1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ch_str</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tks_feat</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ch_str</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="n">halign</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="o">*</span><span class="n">win_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scientific_notation</span><span class="p">:</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">rf</span><span class="s1">&#39;$\</span><span class="si">{</span><span class="n">vals_dict</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vals_dict</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
        <span class="n">leg</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">_comp_bar_plot.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sensitivities across Input Features, RMS over Output Channels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Mean Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Std of Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># Plot the averages across the time windows for each channel as line plots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">scientific_notation</span><span class="p">:</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.3</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">sum_mean_std_list</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">alphas</span><span class="p">,</span> <span class="n">vals_dict</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]):</span>
        <span class="n">sum_mean_feature</span><span class="p">,</span> <span class="n">sum_std_feature</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># unpack tuple</span>
        <span class="n">rms_sum_out</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_mean_feature</span><span class="p">)</span>
        <span class="n">std_sum_out</span> <span class="o">=</span> <span class="n">_reshape_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">sum_std_feature</span><span class="p">)</span>
        <span class="n">mean_rms_inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_sum_out</span><span class="p">[:</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_rms_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rms_sum_out</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_std_inp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std_sum_out</span><span class="p">[:</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_std_rec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">std_sum_out</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">:,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scientific_notation</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_rms_inp</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_rms_rec</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_std_inp</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_std_rec</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_rms_inp</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_rms_rec</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_std_inp</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">)</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">mean_std_rec</span><span class="p">[</span><span class="o">-</span><span class="n">win_size</span><span class="p">:]]),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">)</span>
    
    <span class="n">time_deltas</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">10</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="mi">20</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">25</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">30</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="mi">40</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mi">50</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="mi">75</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="mi">100</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="mi">125</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="mi">150</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="mi">175</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span>
        <span class="mi">200</span><span class="p">:</span> <span class="mi">40</span>
    <span class="p">}</span>
    <span class="n">time_delta</span> <span class="o">=</span> <span class="n">time_deltas</span><span class="p">[</span><span class="n">win_size</span><span class="p">]</span>
    <span class="n">time_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;t-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">win_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">time_delta</span><span class="p">)][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">time_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scientific_notation</span><span class="p">:</span>
        <span class="n">legend_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">value</span><span class="p">)</span> \
                          <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">vals_dict</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">legend_entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> \
                          <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">vals_dict</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="s1">&#39;Comparison&#39;</span> <span class="ow">in</span> <span class="n">use_case</span><span class="p">:</span>
            <span class="n">legend_anchor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.275</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;Steering&#39;</span> <span class="ow">in</span> <span class="n">use_case</span><span class="p">:</span>
            <span class="n">legend_anchor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.21</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">legend_anchor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.213</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_zero_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ax_one_label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Sliding Time Window  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">win_size</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">time_delta</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scientific_notation</span><span class="p">:</span>
            <span class="n">leg_one</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_entries</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">rf</span><span class="s1">&#39;$\</span><span class="si">{</span><span class="n">vals_dict</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
            <span class="n">leg_two</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">),</span>
                                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recurrent&#39;</span><span class="p">)],</span>
                                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leg_one</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_entries</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">vals_dict</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
            <span class="n">leg_two</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Input&#39;</span><span class="p">),</span>
                                <span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recurrent&#39;</span><span class="p">)],</span>
                                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">legend_anchor</span><span class="p">)</span>
        <span class="n">leg_one</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
        <span class="n">leg_two</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">leg_one</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">leg_two</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">_comp_sliding_time_window.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Sensitivities across Time Window for all Input Channels, RMS over Output Channels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;RMS of Mean Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sum of Std of Sensitivities&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_first_weight_matrix">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_first_weight_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_first_weight_matrix</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">abs_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ch_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize the model&#39;s first weight matrix and subsequent slices of it</span>
<span class="sd">    as heatmaps, to compare with the sensitivity plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : nn.module</span>
<span class="sd">        Model consisting of nn.Modules</span>
<span class="sd">    abs_values : bool, optional</span>
<span class="sd">        If the absolute values of the weight matrix entries should be plotted.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    save_path : string, optional</span>
<span class="sd">        Path to save the plots. The default is None, i.e. the plots are not saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">)</span>
        <span class="n">use_case_str</span> <span class="o">=</span> <span class="n">use_case</span> <span class="k">if</span> <span class="n">use_case</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;Evaluation_plots&#39;</span><span class="p">,</span> <span class="n">use_case_str</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="c1"># print(name)</span>
            <span class="c1"># print(param.shape)</span>
            <span class="n">weight_matrix</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">break</span>

    <span class="n">input_channels</span><span class="p">,</span> <span class="n">pred_size</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">pred_size</span>
    <span class="n">out_features</span><span class="p">,</span> <span class="n">in_features</span> <span class="o">=</span> <span class="n">weight_matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rec_start_idx</span> <span class="o">=</span> <span class="n">input_channels</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span>
    <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">))</span> <span class="o">+</span> \
                    <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">in_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">))</span>
    <span class="n">y_tks_feat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_features</span><span class="o">//</span><span class="mi">4</span><span class="p">))</span>

    <span class="n">ch_size</span> <span class="o">=</span> <span class="n">input_channels</span> <span class="o">+</span> <span class="n">pred_size</span>
    <span class="n">ch_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Inp_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_channels</span><span class="p">)]</span> <span class="o">+</span> \
        <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Rec_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span>
    <span class="n">inp_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">ch_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)[:</span><span class="n">input_channels</span><span class="p">]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Out_ch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_size</span><span class="p">)]</span> <span class="k">if</span> <span class="n">ch_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ch_names</span><span class="p">[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    <span class="n">out_str</span> <span class="o">=</span> <span class="n">_convert_to_latex</span><span class="p">(</span><span class="n">ch_names</span><span class="p">,</span> <span class="n">out_str</span><span class="p">,</span> <span class="n">use_case</span><span class="p">)[</span><span class="o">-</span><span class="n">pred_size</span><span class="p">:]</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="mi">65</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="k">if</span> <span class="n">ch_size</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

    <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span>
    <span class="n">abs_str</span> <span class="o">=</span> <span class="s1">&#39;signed values&#39;</span>
    <span class="k">if</span> <span class="n">abs_values</span><span class="p">:</span>
        <span class="n">weight_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">weight_matrix</span><span class="p">)</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span>
        <span class="n">abs_str</span> <span class="o">=</span> <span class="s1">&#39;absolute values&#39;</span>
    <span class="n">input_ch_matrix</span> <span class="o">=</span> <span class="n">weight_matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="n">rec_start_idx</span><span class="p">]</span>
    <span class="n">rec_ch_matrix</span> <span class="o">=</span> <span class="n">weight_matrix</span><span class="p">[:,</span> <span class="n">rec_start_idx</span><span class="p">:]</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
    <span class="n">pos0</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">weight_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_features</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tks_feat</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_tks_feat</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">pos1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">input_ch_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_features</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ch_names</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">inp_str</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_tks_feat</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">pos2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rec_ch_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_features</span><span class="o">-</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_features</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_features</span><span class="o">-</span><span class="n">rec_start_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ch_names</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">out_str</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_tks_feat</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># delete empty subplot</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Input Features  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Output Features  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;weight_matrix_one.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;1st Weight Matrix and Slices of Input &amp; Recurrent Channels (</span><span class="si">{</span><span class="n">abs_str</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$1^</span><span class="si">{st}</span><span class="s1">$ Weight Matrix (full)&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Weight Matrix slice of Input Channels&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Weight Matrix slice of Recurrent Channels&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_all_weight_matrices">
<a class="viewcode-back" href="../../visualization.html#softsensor.visualization.plot_all_weight_matrices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_all_weight_matrices</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">abs_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rel_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">use_case</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize all weight matrices of the model as heatmaps and their distributions</span>
<span class="sd">    as histograms, highlighting the percentage of weights that fall within a</span>
<span class="sd">    certain threshold range.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : nn.module</span>
<span class="sd">        Model consisting of nn.Modules</span>
<span class="sd">    abs_values : bool, optional</span>
<span class="sd">        If the absolute values of the weight matrix entries should be plotted.</span>
<span class="sd">        The default is False.</span>
<span class="sd">    rel_threshold : float, optional</span>
<span class="sd">        Threshold value for the percentage of weights that fall within the range [-threshold, threshold].</span>
<span class="sd">        The default is 0.1, i.e. 10 % of the maximum absolute value of each weight matrix.</span>
<span class="sd">    use_case : string, optional</span>
<span class="sd">        Use case for the channel names. The default is None.</span>
<span class="sd">    save_path : string, optional</span>
<span class="sd">        Path to save the plots. The default is None, i.e. the plots are not saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">BASE_PATH</span><span class="p">)</span>
        <span class="n">use_case_str</span> <span class="o">=</span> <span class="n">use_case</span> <span class="k">if</span> <span class="n">use_case</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="s1">&#39;Evaluation_plots&#39;</span><span class="p">,</span> <span class="n">use_case_str</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">abs_values</span><span class="p">:</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span>
        <span class="n">abs_str</span> <span class="o">=</span> <span class="s1">&#39;absolute values&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;coolwarm&#39;</span>
        <span class="n">abs_str</span> <span class="o">=</span> <span class="s1">&#39;signed values&#39;</span>

    <span class="n">w_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">w_len</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">3</span>
    <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">w_len</span> <span class="o">/</span> <span class="n">num_cols</span><span class="p">))</span>
    <span class="n">fig_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">num_cols</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="c1"># plot the values of the weight matrices as imshow plots</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
    <span class="n">rec_start_idx</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">input_channels</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="n">w_len</span><span class="p">])):</span>
        <span class="n">out_features</span><span class="p">,</span> <span class="n">in_features</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">x_step</span> <span class="o">=</span> <span class="n">in_features</span><span class="o">//</span><span class="mi">4</span> <span class="k">if</span> <span class="n">in_features</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">in_features</span><span class="o">//</span><span class="mi">5</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># first matrix only</span>
            <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">window_size</span><span class="p">))</span> <span class="o">+</span> \
                            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">rec_start_idx</span><span class="p">,</span> <span class="n">in_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">rnn_window</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_tks_feat</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_step</span><span class="p">)</span>
        <span class="n">y_step</span> <span class="o">=</span> <span class="n">out_features</span><span class="o">//</span><span class="mi">4</span> <span class="k">if</span> <span class="n">out_features</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">y_tks_feat</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">out_features</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_step</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">colormap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_features</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">rel_threshold</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_outside</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">-</span><span class="n">threshold</span><span class="p">,</span> <span class="n">threshold</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                    <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_features</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out_features</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tks_feat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">in_features</span><span class="o">//</span><span class="n">win_size</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="n">model</span><span class="o">.</span><span class="n">input_channels</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()[</span><span class="o">-</span><span class="n">model</span><span class="o">.</span><span class="n">pred_size</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_tks_feat</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Input features  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Output features  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Weight Matrix </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># delete empty subplots</span>
    <span class="n">num_del_axes</span> <span class="o">=</span> <span class="n">num_rows</span><span class="o">*</span><span class="n">num_cols</span> <span class="o">-</span> <span class="n">w_len</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_del_axes</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">-</span><span class="n">i</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;weight_matrices.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Weight matrices (</span><span class="si">{</span><span class="n">abs_str</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># create own legend entries for the histograms</span>
    <span class="c1"># legend_entries = [Patch(facecolor=&#39;skyblue&#39;, edgecolor=&#39;black&#39;, label=&#39;Inside&#39;),</span>
    <span class="c1">#                   Patch(facecolor=&#39;mediumaquamarine&#39;, edgecolor=&#39;black&#39;, label=&#39;Outside&#39;)]</span>

    <span class="c1"># plot the distributions of the weight matrices as histograms</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_rows</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="n">w_len</span><span class="p">])):</span>
        <span class="n">counts</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">rel_threshold</span> <span class="o">*</span> <span class="n">max_value</span>
        <span class="c1"># color all those bins that fall in the range [-threshold, threshold] in green</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bins</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">threshold</span> <span class="ow">and</span> <span class="n">bins</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">patches</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;mediumaquamarine&#39;</span><span class="p">)</span>
        <span class="c1"># compute how many percent of the weights fall in the range [-threshold, threshold]</span>
        <span class="n">percentage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">threshold</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Weight Matrix </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Max. value: </span><span class="si">{</span><span class="n">max_value</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">, 10% Threshold: +-</span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Percentage of weights within threshold range: </span><span class="si">{</span><span class="n">percentage</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Weight value  $[-]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Density $[\%]$&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Weight Matrix </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># ax.legend(handles=legend_entries, title=rf&#39;$\mathcal{{T}}$ $\in$ [{-threshold:.3f}, {threshold:.3f}]&#39;, loc=&#39;upper left&#39;)</span>
    
    <span class="c1"># delete empty subplots</span>
    <span class="n">num_del_axes</span> <span class="o">=</span> <span class="n">num_rows</span><span class="o">*</span><span class="n">num_cols</span> <span class="o">-</span> <span class="n">w_len</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_del_axes</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">-</span><span class="n">i</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;weight_distributions.pdf&#39;</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Weight distributions of the matrices&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def plot_quantiles(model, track, t_start, t_end, output=0, fs=10, show_legend=False, title=None, title_info=None, fig_path=None, is_duffing=True, plot_all=False, show=True):</span>
<span class="sd">    &quot;&quot;&quot; Runs the QR prediction on track and plots the quantiles</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: QuantileNARX</span>
<span class="sd">        QR model to use for prediction</span>
<span class="sd">    track: torch.Dataloader</span>
<span class="sd">        Single track</span>
<span class="sd">    t_start: int, optional</span>
<span class="sd">        Start of plotting window. The default is None.</span>
<span class="sd">    t_end: int, optional</span>
<span class="sd">        End of plotting window. The default is None.</span>
<span class="sd">    output: int, optional</span>
<span class="sd">        Output sensor to plot. The default is 0.</span>
<span class="sd">    fs: int, optional</span>
<span class="sd">        Sampling rate of dataset to rescale x axis. The default is 10.</span>
<span class="sd">    show_legend : bool, optional   </span>
<span class="sd">        Show legend in the plot. The default is False</span>
<span class="sd">    title: string, optional</span>
<span class="sd">        Title for the plot. The default is None</span>
<span class="sd">    title_info: dict[string,string], optional</span>
<span class="sd">        Must contain keys [&#39;dataset&#39;, &#39;model&#39;, &#39;track&#39;, &#39;sensor&#39;]. The default is None.</span>
<span class="sd">    fig_path : string, optional   </span>
<span class="sd">        Path to save fig. The default is None</span>
<span class="sd">    is_duffing: bool, optional</span>
<span class="sd">        Whether it is position prediction (like Duffing dataset) or acceleration prediction. The default is True.</span>
<span class="sd">    plot_all: bool, optional</span>
<span class="sd">        Whether to plot all quantiles or only the 67.5% and 95% PI. The default is False.</span>
<span class="sd">    show: bool, optional</span>
<span class="sd">        If the plot should be displayed. The default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<span class="sd">    sns.set(style=&quot;white&quot;)</span>

<span class="sd">    pred = model.prediction(track)</span>
<span class="sd">    predicted_quantiles = [x[output] for x in pred]</span>
<span class="sd">    ground_truth = torch.tensor([data[1][0][output][0] for data in track])</span>
<span class="sd">    median = predicted_quantiles[0]</span>
<span class="sd">    </span>
<span class="sd">    mse = nn.MSELoss()(median, ground_truth)</span>
<span class="sd">    print(f&quot;MSE: {mse}&quot;)</span>

<span class="sd">    window = slice(t_start, t_end)</span>
<span class="sd">    length = len(median[window])</span>
<span class="sd">    x = np.arange(0, length) + (0 if not t_start else t_start)</span>
<span class="sd">    x = x/fs</span>
<span class="sd">    </span>
<span class="sd">    sns.lineplot(x=x, y=ground_truth[window], color=sns.color_palette()[1], label=&quot;Ground Truth&quot;, legend=show_legend)</span>
<span class="sd">    sns.lineplot(x=x, y=median[window], color=sns.color_palette()[0], label=&quot;Prediction &quot;, legend=show_legend)</span>
<span class="sd">    </span>
<span class="sd">    if plot_all:</span>
<span class="sd">        for lb, ub in zip(predicted_quantiles[1::2], predicted_quantiles[2::2]):</span>
<span class="sd">            plt.fill_between(x, lb[window], ub[window], color=sns.color_palette()[0], alpha=0.2)</span>
<span class="sd">    else:</span>
<span class="sd">        # Only plot the 67.5% and 95% PI (similar to first and second std of Gaussian)</span>
<span class="sd">        plt.fill_between(x, predicted_quantiles[1][window], predicted_quantiles[2][window], color=sns.color_palette()[0], alpha=0.36666)</span>
<span class="sd">        plt.fill_between(x, predicted_quantiles[13][window], predicted_quantiles[14][window], color=sns.color_palette()[0], alpha=0.5)</span>
<span class="sd">    </span>
<span class="sd">    export_plot(show_legend, title, title_info, fig_path, is_duffing, show)</span>
<span class="sd"> &#39;&#39;&#39;</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Bosch CR.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>